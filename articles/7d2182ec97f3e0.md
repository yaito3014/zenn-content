---
title: "ãƒ¡ã‚¿é–¢æ•°ã®ã‚«ãƒªãƒ¼åŒ–"
emoji: "ğŸª“"
type: "tech"
topics:
  - "cpp"
published: true
published_at: "2021-03-03 17:57"
---

### åºæ–‡

ãƒ¡ã‚¿é–¢æ•°ã‚’ã‚«ãƒªãƒ¼åŒ–ã—ãŸã„ã€ã¨èª°ã‚‚ãŒä¸€åº¦ã¯æ€ã†ã¯ãš[^1]ã§ã™ã€‚  
ãªã®ã§æ—©é€Ÿã‚„ã£ã¦ã„ãã¾ã™ã€‚  

### ãƒ¡ã‚¿é–¢æ•°ã®ä½œæˆ
 
ã¾ãšã‚„ã‚ŠãŸã„äº‹ã‚’æ˜ç¢ºã«ã—ã¾ã™ã€‚ã‚«ãƒªãƒ¼åŒ–ã¨ã„ã†ãã‚‰ã„ã§ã™ã‹ã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ããŸã„ã§ã™ã­ã€‚

```cpp
template <class T, class U> struct X {};
using curried = curry<X>::type;
static_assert(std::is_same<curried<T><U>, X<T, U>>::value);
```

ã—ã‹ã— `curried<T><U>` ãªã©ã¨ã„ã†æ›¸ãæ–¹ã¯å‡ºæ¥ã¾ã›ã‚“ã‹ã‚‰ã€ `curried::ident<T>::ident<U>` ã®ã‚ˆã†ã«è­˜åˆ¥å­ã‚’æŒŸã‚“ã§ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
å–ã‚Šæ•¢ãˆãšã“ã‚Œã‚’ä½œã‚‹ã“ã¨ã‚’ç›®æ¨™ã«ã—ã¾ã™ã€‚  
 
ã§ã¯å‡ºåŠ›ã•ã‚Œã¦æ¬²ã—ã„å‹ã‚’è€ƒãˆã¦ã¿ã¾ã™ã€‚  
å…ˆç¨‹ã®ã‚ˆã†ã«ã—ãŸã‘ã‚Œã°ç´ ç›´ã«

```cpp
struct curried {
  template <class T>
  struct impl {
    template <class U>
    using ident = X<T, U>;
  };
  template <class T>
  using ident = impl<T>;
};
```

ã¨ã„ã†å‹ãŒã‚ã‚Œã°è‰¯ã„ã§ã™ãŒã€ä¸Šè¨˜ã®ã¾ã¾ã ã¨å¼•æ•°ãŒå¢—ãˆãŸå ´åˆ  

```cpp
template <class T1, class T2, class T3> struct Y {};

struct curried {
  template <class T1>
  struct impl1 {
  	template <class T2>
  	struct impl2 {
  	  template <class T3>
  	  using ident = Y<T1, T2, T3>;
  	};
  	template <class T2>
  	using ident = impl2<T2>;
  };
  template <class T>
  using ident = impl1<T>;
};
```

ã®ã‚ˆã†ã«ãªã‚Šã€ç”Ÿæˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ `impl` ãŒè¡çªã—ã¦å„ä»‹ãªã“ã¨ã«ãªã‚Šãã†ã§ã™ã€‚  
ãªã®ã§ä¸€æ—¦ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹é€ ã‚’è€ƒãˆã¾ã™ã€‚  

```cpp
struct curried {
  using type = struct {
    template <class T>
    struct ident {
      using type = struct {
        template <class U>
        struct ident {
          using type = X<T, U>;
        };
      };
    };
  };
};
```

ãã‚Œãã‚Œã®éšå±¤ã« `type` ã‚’æŒŸã‚€ã“ã¨ã§è¡çªã¯é¿ã‘ã‚Œã¾ã—ãŸãŒã€ä½¿ãŠã†ã¨ã™ã‚‹ã¨ `curried::type::ident<T>::type::ident<U>::type` ã®ã‚ˆã†ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚  
ã—ã‹ã—å˜ç´”ãªå†å¸°çš„æ§‹é€ ã§å®Ÿè£…ã¯æ¥½ãã†ã§ã™ã®ã§ã€ä¸€åº¦ã“ã‚Œã§å®Ÿè£…ã—ã¾ã™ã€‚  

```cpp
template <class...> using void_t = void;

template <class, template <class...> class T, class... Ts>
struct curried {
  using type = struct {
    template <class U>
    using ident = curried<void, T, Ts..., U>;
  };
};

template <template <class...> class T, class... Ts>
struct curried<void_t<T<Ts...>>, T, Ts...>  {
  using type = T<Ts...>;
};

template <template <class...> class T>
struct curry { using type = curried<void, T>; };

template <template <class...> class T> 
using curry_t = typename curry<T>::type;
```

ä»•çµ„ã¿ã¨ã—ã¦ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã® `T` ã«å¯¾ã—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ‘ãƒƒã‚¯ `Ts...` ã‚’ä¸ãˆã¦å®Ÿä½“åŒ–å¯èƒ½ãªã‚‰ã°é©ç”¨ã—ã€ä¸å¯èƒ½ãªã‚‰ã°ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ‘ãƒƒã‚¯ã«å‹ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã® `ident` ã‚’æä¾›ã™ã‚‹ã€ã¨ã„ã£ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚  
 
ã“ã“ã§ã€ `curry_t<X>::type::ident<T>::type::ident<U>::type` ã® `curry_t<X>::type` ä»¥é™ã¯ `ident<T>::type` ã®ç¹°ã‚Šè¿”ã—ãªã®ã§ã€`curry` ã«æ‰‹ã‚’åŠ ãˆã¦

```cpp
template <template <class...> class T>
struct curry { using type = typename curried<void, T>::type; };
```

ã•ã‚‰ã« `ident<T>::type` ã«å½“ãŸã‚‹éƒ¨åˆ†ã‚’ã¾ã¨ã‚ã¦ `apply<T>` ã¨ã§ã‚‚åä»˜ã‘ã¦ã—ã¾ãˆã°

```cpp
template <class, template <class...> class T, class... Ts>
struct curried {
  using type = struct {
    template <class U>
    using apply = typename curried<void, T, Ts..., U>::type;
  };
};
```

æ™´ã‚Œã¦ `curry_t<X>::apply<T>::apply<U>` ã®ã‚ˆã†ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  
 
å¾Œã¯é©å®œãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚¿é–¢æ•°ã‚’ç”¨æ„ã—ã¦ã—ã¾ãˆã°

```cpp
template <class T, class... Us>
struct apply_to {};

template <class T>
struct apply_to<T> {
  using type = T;
};

template <class T, class U>
struct apply_to<T, U> {
  using type = typename T::template apply<U>;
};

template <class T, class U1, class U2, class... Us>
struct apply_to<T, U1, U2, Us...>
    : apply_to<typename apply_to<T, U1>::type, U2, Us...> {};

template <class T, class... Us>
using apply_to_t = typename apply_to<T, Us...>::type;
```

ã ã„ã¶ä½¿ã„ã‚„ã™ããªã‚‹ã¨æ€ã„ã¾ã™ã€‚  
 
### ãƒ©ãƒ ãƒ€è¨ˆç®—

æµçŸ³ã«ä½œã£ãŸã ã‘ã§ã¯å‘³æ°—ãªã„ã®ã§ã€ä½•ã‹ã‚„ã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  
æ‰‹é ƒãªã‚‚ã®ã¨ã—ã¦ã¯ãƒ©ãƒ ãƒ€è¨ˆç®—ã§ã—ã‚‡ã†ã‹ã€‚  
ã¾ãšã¯è‡ªç„¶æ•°ã‚’å®šç¾©ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚  
ã‚‚ã¡ã‚ã‚“è‡ªç„¶æ•°ã¯ã‚¼ãƒ­ã‹ã‚‰[^2]ã§ã™ã®ã§ã€ã¯ã˜ã‚ã«ã‚¼ãƒ­ã‚’ä½œã‚Šã¾ã™ã€‚  

```cpp
// Î»fx.x
template <class F, class X> using zero = X;
using _0 = curry_t<zero>;
```

ãã—ã¦ `succ` é–¢æ•°ã‚‚ä½œã‚Œã°

```cpp
// Î»nfx.f(nfx)
template <class N, class F, class X>
using succ_t = apply_to_t<F, apply_to_t<N, F, X>>;
using succ_c = curry_t<succ_t>;
```

è‡ªç„¶æ•°ãŒä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚  

```cpp
using _1 = succ_c::apply<_0>;
using _2 = succ_c::apply<_1>;
using _3 = succ_c::apply<_2>;
using _4 = succ_c::apply<_3>;
using _5 = succ_c::apply<_4>;
```

åˆ©ä¾¿æ€§ã®ãŸã‚ `integral_constant` ã¸ã®å¤‰æ›ã‚‚ä½œã£ã¦ãŠãã¾ã™ã€‚

```cpp
template <int X> using int_t = std::integral_constant<int, X>;
template <class T> struct inc : int_t<T::value + 1> {};
using inc_c = curry_t<inc>;
template <class T> using to_num = apply_to_t<T, inc_c, int_t<0>>;
```

`add` `mul` `pow` ã‚’ä½œã‚Œã°ã€

```cpp
template <class L, class R, class F, class X>
using add_t = apply_to_t<L, F, apply_to_t<R, F, X>>;
using add_c = curry_t<add_t>;

template <class L, class R, class F>
using mul_t = apply_to_t<L, apply_to_t<R, F>>;
using mul_c = curry_t<mul_t>;

template <class L, class R>
using pow_t = apply_to_t<R, L>;
using pow_c = curry_t<pow_t>;
```

å¾Œã¯æ€ã†å­˜åˆ†ãƒ©ãƒ ãƒ€è¨ˆç®—ã‚’æ¥½ã—ã‚ã¾ã™ã€‚  

```cpp
static_assert(to_num<apply_to_t<add_c, _2, _3>>::value == 5);

using f = mul_c::apply<_2>;
static_assert(to_num<f::apply<_3>>::value == 6);
static_assert(to_num<f::apply<_5>>::value == 10);

template <class F, class X, class Y>
using flip_t = apply_to_t<F, Y, X>;
using flip_c = curry_t<flip_t>;

using g = apply_to_t<flip_c, pow_c, _3>;
static_assert(to_num<g::apply<_2>>::value == 8);
static_assert(to_num<g::apply<_3>>::value == 27);
```
 
 

### è›‡è¶³
æŠ€è¡“ç³»è¨˜äº‹ã®åŸ·ç­†ã¯åˆã‚ã¦ãªã®ã§æ‹™ã„ã‚‚ã®ã¨ãªã‚Šã¾ã—ãŸãŒã”å®¹èµ¦ãã ã•ã„ã€‚  
ãƒã‚µã‚«ãƒªãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚  

â€»ã“ã®è¨˜äº‹ã¯ã€[ã¯ã¦ãªãƒ–ãƒ­ã‚°ã«æŠ•ç¨¿ã—ãŸè¨˜äº‹](https://yaito3014.hatenablog.com/entry/2021/02/21/162210)ã®ç§»æ¤ç‰ˆã¨ãªã‚Šã¾ã™ã€‚  

[^1]: ãˆï¼Ÿæ€ã‚ãªã„ï¼Ÿãã†ã§ã™ã‹â€¦  
[^2]: ã“ã“ã§ã¯ãƒšã‚¢ãƒå…¬ç†ã«å¾“ã„ã¾ã™  